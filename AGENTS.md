# AGENTS運用: 通知ポリシーと手順

このリポジトリでの通知の扱いを定義します。以後のタスクは
本方針に従い、終了時にサマリー付き通知を送ります。

## Agent必須ルール（重要）

- すべてのタスクは「完了時に通知」を必ず実施すること。なお、短時間で完了する探索系（FAST等）のジョブについては通知過多を避けるため、既定で完了通知を行いません（`JOB_CLASS=fast` もしくは `SUPPRESS_NOTIFY=1` を環境に設定すると `make notify`/`make notify-done` が自動スキップされます）。
- Bashスクリプトは「実行」専用（source禁止）。全スクリプトに誤source防止ガードを実装済み。
- 既定の手順: `make notify-done-site` を実行して通知＋サイト更新をまとめて行う。
  - サイト更新が不要な場合のみ、`make notify-done` を用いる。
- 通知本文は直近の `memo/run_*.md` から自動抽出されるため、作業の要点は必ず `memo/run_*.md` に記録すること。
- 長時間(10分以上)かかるスクリプトの実行は、ログ等で進捗が確認できる状態でバックグラウンド実行すること。

## TODO.md 運用（手動/半自動）

- `TODO.md` は常設のバックログ。各タスクは原則1行・簡潔に記述し、詳細は `memo/` に分離する。
- 重要度の高いものから順に実行する（例: `[urgent]` タグや語句で簡易判定）。
- タスクの途中で新たなサブタスクを見つけた場合は `TODO.md` に追記する。
- 実行は手動で行い、完了した行は `TODO.md` から削除する。
- 進捗共有はポリシーに従い `make notify-done-site` を任意のタイミング（通常は完了時）で実施する。

## 基本方針

- タイミング: 各タスク終了時に1回送信する
- タイトル: タスク要約（簡潔、全角30文字目安）
- 本文:
  - 結果: 1〜3行で結論と要点
  - 主要変更点: 追加/更新したファイルや成果
  - 次の一手: フォローアップや依頼事項
- サブタイトル: 任意（例: 成功/警告/要確認 など）
- 送信先:
  - 必須: talker/notice
  - 任意: Slack（`SLACK_WEBHOOK_URL`設定時）

## 実装/送信手段

- スクリプト: `scripts/notice.sh`
  - 既定は非同期送信（`-a`未指定）
  - アクションボタン指定時（`-a ...`）は同期で応答待ち
- Makeターゲット: `make notify`
  - `.env`を自動読込し、簡易に送信できる

## サブエージェント連携

- サブエージェントに作業を指示した際は、**必ず「内容を理解した」旨の応答を得てから着手**させる。  
- そのサブエージェントが実際に作業へ入るタイミングで、一度ステータス報告（例:「着手した」「準備完了」など）を受け、以降の進捗管理に利用する。  
- tmux/screen などで監視用ウィンドウを作成する場合は、**ウィンドウ名に `agent-` プレフィックスを付けない**（例: `gate-perm-watch` など役割ベースの名称を用いる）。既存のプレフィックス付き名称があれば順次リネームする。  
- これらのやり取りは `memo/run_*.md` に記録し、必要に応じて通知本文の「次の一手」に反映する。

## 完了時の標準オペレーション（必須）

- 各タスク終了時に、直近の実行メモから要点を抽出して通知を送る。
- 実行コマンド:

  ```sh
  make -C gravitation notify-done
  ```

- 仕様:
  - `memo/run_*.md` のうち最も新しいファイルから「結果サマリ」「生成物」「次アクション」を抽出。
  - タイトルは `作業完了: run_YYYY-MM-DD` 形式。
  - `.env` の `AGENT_TOKEN` を読み込み、`scripts/notice.sh` を介して送信。
  - メモが無い場合は簡易サマリ（レポート再生成等）で送信。

- 事前準備（初回のみ）:
  1) `gravitation/.env.example` を `gravitation/.env` にコピー
  2) `AGENT_TOKEN` を設定（任意で `SLACK_WEBHOOK_URL` も）

  ```sh
  cp gravitation/.env.example gravitation/.env
  sed -i 's/^AGENT_TOKEN=.*/AGENT_TOKEN=<提供トークン>/' gravitation/.env
  ```

## 参考ドキュメント

- Runbook: `docs/runbook.md`（`scripts/notice.sh` の使い方詳細）
- ポリシー: `memo/notification_policy.md`
- 調査: `memo/notice_script_review.md`, `memo/notification_survey.md`

## 前提とセキュリティ

- 必須環境変数: `AGENT_TOKEN`（機密。`.env`で管理）
- 任意環境変数: `SLACK_WEBHOOK_URL`
- `.env`はコミット禁止。共有は`.env.example`を参照

### 資格情報の取り扱い（重要）

- `AGENT_TOKEN` は通信ゲートウェイにアクセスするための機密トークンです。平文でのリポジトリへの記載・コミットは厳禁です。
- 設定手順:
  1) `cp .env.example .env`
  2) `.env` の `AGENT_TOKEN=` に提供されたトークン値を設定（例: `AGENT_TOKEN=<provided-token>`）
  3) 通知時は Makefile が `.env` を自動読込し、`scripts/notice.sh` が `AGENT_TOKEN` を利用して送信します。
- 備考: 受信サービス未稼働／ネットワーク不達時でも、`server/public/notifications/` にファイルミラーされるため、通知は常にダッシュボードから参照可能です。

## 送信例

最小:

```sh
./scripts/notice.sh -m "ジョブ完了" -t "テスト更新"
```

Make経由:

```sh
make notify MSG="ジョブ完了" TITLE="テスト更新"
```

アクション付き（同期）:

```sh
./scripts/notice.sh -m "再起動しますか" -t "メンテ" \
  -S "返答を選択してください" -a "OK,キャンセル"
```

## フォーマットガイド

- 行は80桁以内を目安に短く保つ
- 箇条書きで簡潔に。英数+日本語は無空白で記述（例: DB設定）

## 障害時の扱い

- 非同期送信はHTTP成否を保持しない。重要通知は一時的に
  `-a`を付け同期で確認、またはサーバ側ログで検証する
- 失敗が続く場合は手動で再送し、原因をmemoに記録する

## TODO運用（必須）

目的: 作業中に見つけた別タスクを漏れなく捕捉し、短い粒度で共有する。

- 保持場所: リポジトリ直下の `TODO.md`（常設）。
- 記入単位: 各タスクは1行で記述（80桁目安、簡潔）。
- 詳細対応: 長くなる説明や検討内容は `memo/` 配下にメモを作成し、
  `TODO.md` には要約＋メモのファイル名のみを記載する。
  - 例: `APIのリトライ方針検討 — memo/api_retry_memo.md`
- 記入タイミング: 作業中に発見した時点で随時追記する（タスク切り出し時に必ず反映）。
- 通知連携: タスク終了時の通知「次の一手」に、`TODO.md` に追記したフォローアップの要点
  とメモファイル名（ある場合）を含める。
- 「TODO消化」という指示があった場合、以下を実施する
 1. TODO.mdから最も重要なものを1件選んで実行する
 2. 完了したらTODO.mdから完了した項目を削除する
 3. TODO.mdが空でなければ1に戻る

備考:
- 必要であれば先頭に任意の軽量タグを付けてよい（例: `[low]`, `[urgent]`）。
- メモの命名は任意だが、`memo/todo_YYYY-MM-DD_<slug>.md` など一貫した命名を推奨。
