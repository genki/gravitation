# notice投稿スクリプトの調査メモ

対象: ユーザー提示のbashスクリプト（talker/notice経由で通知）。
日時: 2025-08-27 (JST同日)

## 目的

- 依存関係と前提の確認。
- この環境での実行可否評価。
- 到達性の軽い検証。
- 改善点の提案。

## 概要

- `AGENT_TOKEN`必須。未設定なら即終了。
- JSONを`jq`で生成し、`curl`で下記にPOST:
  `https://agent-gate.s21g.com/moon/$AGENT_TOKEN/@localhost:8082/notice`
- ファイル指定時は`multipart/form-data`、未指定時はJSON。
- `-a`アクションありの時は同期で待機、なければ非同期で実行。
- `SLACK_WEBHOOK_URL`があれば同内容をSlackにもポスト（常に非同期）。

## 依存関係（この環境）

- bash, curl, jq, git, date: すべて存在。
  - curl 8.5.0, jq 1.7 を確認。
- 必須環境変数:
  - `AGENT_TOKEN`: 未設定（2025-08-27時点）。
  - `SLACK_WEBHOOK_URL`: 未設定。

## サービス/ネットワーク到達性

- ローカル `127.0.0.1:8082` はLISTEN中（IPv4/IPv6）。
  - `GET /health`, `/notice`, `/` は 404。
  - `POST /notice` に最小JSONを送信すると 500。
  - いずれも応答あるため、何らかのHTTPサーバは稼働。
- `https://agent-gate.s21g.com/` は 404 応答（TLS/名前解決OK）。

## この環境での実行可否

- `AGENT_TOKEN`が未設定のため、スクリプトは開始直後に終了。
- 直接`http://127.0.0.1:8082/notice`へ送る実装ではない。
  そのため現状のままでは実行不可。

## 動作仕様の要点

- JST時刻をタイトル先頭に付与（例: `"14:03 通知"`）。
- `-a`指定時はサブタイトル既定文を自動付与。
- ファイル添付ありの時はmultipartで送信。
- 非同期送信時はバックグラウンド化し、即時に
  "通知を送信しました" を表示（失敗検知はしない）。

## リスク/注意点

- トークンをURLパスに含めて送信。
  - プロセス一覧、プロキシログ、アクセスログに露出し得る。
  - 可能ならヘッダ（例: `Authorization: Bearer`）化を検討。
- 非同期時は`curl`の成否が取得できない。
  - 失敗時のリトライや通知保証がない。
- Slack webhookはファイル添付やアクションには非対応。

## 改善提案

1) 可観測性と堅牢性
   - `--fail-with-body --retry 3 --retry-all-errors` 等を付与。
   - 非同期の既定を見直し、`--sync`オプション追加。
   - ローカル直送のフォールバック（`NOTICE_BASE_URL`環境変数）。

2) セキュリティ
   - トークンはURLではなくヘッダで送信（サーバ側対応要）。
   - コマンド履歴にURLを残さない運用（wrapper経由実行）。

3) 使い勝手
   - `-n/--dry-run`で送信せずJSONのみ表示。
   - `-v/--verbose`で送信ログを詳細出力。
   - Slackはブロックキット整形のオプションを追加。

## 最小動作テスト手順（想定）

1) 前提の設定
   ```sh
   export AGENT_TOKEN=xxxxxx   # 共有ストアから取得
   # 任意
   export SLACK_WEBHOOK_URL=https://hooks.slack.com/services/...
   ```
2) 送信
   ```sh
   ./scripts/notice.sh -m "hello" -t "テスト"
   ```
3) 応答確認
   - サーバ側ログ、Slack、またはtalkerの受信面を確認。

## 参考ログ（本環境、2025-08-27）

- `127.0.0.1:8082` はLISTEN。
- `GET /health` -> 404, `POST /notice` -> 500。
- `agent-gate.s21g.com` へTLS接続は成功（HTTP 404）。

### 実測（有効トークン適用後）

- 同期経路（`-a`指定）: 接続待機が発生しタイムアウト。
- 非同期経路（`-a`無し）: `通知を送信しました` を即時出力。
  - 実際の配信成否はサーバ側で確認が必要。

## 結論

- 依存は揃っているが、`AGENT_TOKEN`未設定のため現状では
  スクリプト実行不可。トークン準備後に送信テストを推奨。
- 安定運用には非同期時の失敗検知とトークン露出低減の
  措置を併せて導入すると良い。
