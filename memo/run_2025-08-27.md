# 近傍銀河・共有パラメータフィット(実行ログ要約)

- 実行日: 2025-08-27
- コマンド:
  - `PYTHONPATH=. python scripts/compare_fit_multi.py \
    --names-file data/sparc/sets/nearby.txt --boost 0.5 --boost-tie-lam \
    --auto-geo --gas-scale-grid 1.33 \
    --out data/results/multi_fit_nearby.json`
  - `PYTHONPATH=. python scripts/sweep_sensitivity.py`
  - `PYTHONPATH=. python scripts/build_report.py`

## 結果サマリ
- 対象: `DDO154, NGC2403, NGC3198, NGC6946, NGC2903, DDO161, D631-7, DDO064`
- GRのみ(銀河ごとmu最適化): 総χ² ≈ 2.1e5
- ULW(FDB, 共有パラメータ):
  - 最良 `λ≈5 kpc, A≈31.6, gas_scale=1.33`
  - 総χ² ≈ 1.83e5 (GRからの改善を確認)
- 各銀河のmuはULW下でも許容範囲(0.2–0.8)に収まる。

## 感度スイープ
- スイープ軸: `irr_alpha ∈ {0.0,0.3,0.5,0.8}`,
  `nl_gamma ∈ {0.0,0.3,0.6}`、`nl_iter=2`固定。
- 出力: `data/results/sensitivity/nearby_sensitivity.json`
- HTML: `server/public/reports/sensitivity_nearby.html`

## レポート
- `server/public/reports/multi_fit_nearby.html` を生成。
  - 共有パラメータ/χ²/AICの比較、各銀河のmu一覧を掲載。

## 知見メモ
- `λ≈5 kpc`付近は近傍セットで安定(ブーストを`λ`に連動)。
- `gas_scale=1.33`固定によりULW側のAが高めに出るが、
  銀河間の相対関係は維持される。
- 非線形(`nl_gamma>0`)や照度(`irr_alpha>0`)は、
  現セットでは効果小〜中程度。棒/面ブーストは個別適用で要検証。

## 次アクション案
- 共有(λ,A,gas_scale)の妥当性を拡大セットで再検証。
- `auto-geo`適用時のPA/軸比が結果に与える影響を可視化。
- 既存`paper/figures`の図をULW/GRのAIC差で並べ替え。
- FDBカーネルの境界処理検証(テスト追加済み/更にケース拡張)。
- `tests/`を増強(放射源のスケール変化に対するg_Rの安定性など)。

### 追記: 拡大セット(20)の検証 [2025-08-27 21:30]
- セット: `data/sparc/sets/expanded20.txt` を新設(近傍8 + 12件自動抽出)。
- コマンド:
  - `PYTHONPATH=. python scripts/compare_fit_multi.py \
     --names-file data/sparc/sets/expanded20.txt --boost 0.5 --boost-tie-lam \
     --auto-geo --gas-scale-grid 1.0,1.33 \
     --out data/results/multi_fit_expanded20.json`
  - `PYTHONPATH=. python scripts/build_report.py`
- 結果(拡大20):
  - 最良 `λ≈12.0 kpc, A≈100.0, gas_scale=1.33`
  - 総χ²: GR=221,165 / ULW=193,029 → 改善率 ≈ 12.72%
  - JSON: `data/results/multi_fit_expanded20.json`
  - HTML: `server/public/reports/multi_fit_expanded20.html`
- 感度スイープ(拡大20): `irr_alpha ∈ {0.00,0.30,0.50,0.80}`, `nl_gamma ∈ {0.00,0.30,0.60}` の計12本を実行し、各HTMLを生成。
  - 例: `server/public/reports/multi_fit_expanded20_sens_irr0.30_nl0.30.html`
- 所感:
  - 近傍セット同様、ULWはGR(no DM)より一貫してAIC/χ²で優位。
  - λは5→12kpcへややシフト(サンプル拡大の影響)。Aの増分と整合的。
  - `irr_alpha`/`nl_gamma`は現状の軸対称近似では効果は限定的(±1–3%)。

### 追記: 方程式の境界/目的関数の見直し [2025-08-27 22:10]
- 改良点:
  - FFT Yukawa解にゼロパディング(`pad_factor=2`)を導入→外縁での周期境界影響を低減。
  - 単銀河比較に外縁重み(`outer-frac=0.6`,`outer-weight=1.0`)と誤差下限(`eg-frac-floor=0.15`)を追加→内側過重みを緩和し外縁の差を反映。
  - 照度核を`p=1`へ(≈1/r)設定可能にし、外縁寄与の裾を維持。
  - 2帯域混合(λ2=ratio·λ, 重みw)を実装(既定: ratio=4, w=0.4)。
- コード:
  - `src/models/fdbl.py`: `pad_factor`対応と安全なcrop。
  - `scripts/compare_fit_sparc.py`: 外縁重み/誤差下限/2帯域/拡張グリッド。
  - `scripts/compare_fit_multi.py`: 誤差下限/2帯域/拡張グリッド。
  - `scripts/build_vr_batch.py`: 新既定を反映。
- 結果サマリ(拡大20, pad2+p=1):
  - λ≈12–15 kpc, A≈31.6 で χ²は約23%改善(従来基準)。
  - 誤差下限導入時(eg_frac=0.15)もULW優位を維持(相対指標で約15%改善)。
  - 単銀河のV–R図にて、外縁のULW寄与が可視化（GR=赤破線/ULW=青実線、重なり注記を追加）。
