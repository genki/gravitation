# 全銀河(175)・共有パラメータフィット実行ログ

- 実行日: 2025-09-01
- 目的: SPARC全銀河(175)に対し、ULW(FDB)の共有パラメータ(λ, A, gas_scale)
  を共通化して同時フィットし、GR(no DM)との総合比較を行う。

## 実行
- 名前リスト生成: `data/sparc/sets/all.txt` (MassModelsから抽出; 175件)
- コマンド:
  ```sh
  PYTHONPATH=. .venv/bin/python scripts/compare_fit_multi.py \
    --names-file data/sparc/sets/all.txt \
    --boost 0.5 --boost-tie-lam --auto-geo \
    --pad-factor 2 --eg-frac-floor 0.15 --inv1-orth --line-eps 0.8 \
    --gas-scale-grid 1.0,1.33 \
    --lam-grid 5,8,12,15,20 \
    --A-grid 0.01,0.0316,0.1,0.316,1,3.16,10,31.6,100,316 \
    --out data/results/multi_fit_all_orth_eps0.8_eg015.json
  ```
- レポート: `PYTHONPATH=. .venv/bin/python scripts/build_report.py`

## 結果サマリ
- GRのみ(各銀河mu最適): 総χ² ≈ 3.06e4
- ULW(FDB; 共有): 最良 `λ≈20 kpc, A≈100, gas_scale≈1.33`, 総χ² ≈ 8.20e3
- 備考: 1/r項は直交化済み(`--inv1-orth`)、誤差下限`eg-frac-floor=0.15`適用。

## 所見
- サンプル拡大に伴い、λは長め(≈20 kpc)を選好。Aは100付近で安定。
- gas_scaleは1.33がわずかに有利。近傍/拡大20の傾向と整合。
- 銀河ごとの`alpha_line`はタイプ依存で広がるが、共有(λ,A)下でも総合χ²は
  GR比で大きく改善。

## 生成物
- JSON: `data/results/multi_fit_all_orth_eps0.8_eg015.json`
- HTML: `server/public/reports/multi_fit_all_orth_eps0.8_eg015.html`
- セット: `data/sparc/sets/all.txt`（175銀河）

## 次アクション
- タイプ別(LSB/HSB/バー有無/Q)でサブグループの頑健性を評価。
- λ, A 周辺の微細グリッド(例: λ=15,18,20,24; A=80,100,125)で再走査。
- 代表図を本共有(λ=20, A=100, gas=1.33)で固定表示し、SOTAに反映。

---

## 追記: サブグループ解析と代表図更新 (2025-09-01 02:47 UTC)

### サブセット生成
- スクリプト: `scripts/make_subsets.py`
- 生成セット: `data/sparc/sets/lsb.txt(59)`, `hsb.txt(59)`, `q1.txt(99)`, `q2.txt(64)`, `q3.txt(12)`
  - LSB/HSBは`SBdisk0_Lsunpc2`の分位(下位1/3・上位1/3)で自動分割。

### グリッド再走査(共有λ,A)
- 共通オプション: `--boost 0.5 --boost-tie-lam --auto-geo --pad-factor 2 --eg-frac-floor 0.15 --inv1-orth --line-eps 0.8`
- グリッド: `λ∈{15,18,20,24} kpc`, `A∈{80,100,125}`, `gas_scale∈{1.0,1.33}`
- 実行:
  - `data/results/multi_fit_lsb_orth_eps0.8_eg015.json` → 最良: `λ≈18, A≈125, gas≈1.33`, 総χ²≈2.25e3 (GR≈7.33e3)
  - `data/results/multi_fit_hsb_orth_eps0.8_eg015.json` → 最良: `λ≈24, A≈125, gas≈1.33`, 総χ²≈3.07e3 (GR≈1.31e4)
  - `data/results/multi_fit_q1_orth_eps0.8_eg015.json` → 最良: `λ≈20, A≈125, gas≈1.33`, 総χ²≈5.36e3 (GR≈2.09e4)
  - `data/results/multi_fit_q2_orth_eps0.8_eg015.json` → 最良: `λ≈20, A≈125, gas≈1.33`, 総χ²≈2.01e3 (GR≈8.99e3)
  - `data/results/multi_fit_q3_orth_eps0.8_eg015.json` → 最良: `λ≈15, A≈80, gas≈1.0`, 総χ²≈1.90e2 (GR≈6.51e2)
- HTMLレポート再生成: `server/public/reports/index.html` に各ページ追加済み。

所見: サンプルによって最適`λ`はやや変動するが、`A≈100–125`かつ`gas≈1.33`が広範に安定。HSBでは長めの`λ≈24`傾向、LSBでは`λ≈18`寄り。

### 代表図(共有パラメータ固定)の更新
- 条件: `λ=20 kpc, A=100, gas_scale=1.33`
- スクリプト: `scripts/compare_fit_sparc.py --fixed-lam 20 --fixed-A 100 --gas-scale 1.33`
- 生成: `paper/figures/compare_fit_<name>_shared.svg`（先頭6銀河: CamB, D512-2, D564-8, D631-7, DDO064, DDO154）
- SOTAページを再生成: `server/public/state_of_the_art/index.html`

### 次の一手
- サブグループごとの`λ`集約推定(メタ分析)と不確かさ評価。
- HSB/LSBでの`alpha_line`分布比較と系統誤差の点検。
- 共有(λ,A)を`{18,20,24}×{100,125}`に離散化した交差評価(CV)で頑健性を定量化。

## 追記: 代表図全件・群別微細化・分布解析 (2025-09-01 16:50 UTC)

### 共有図の全件生成
- 条件固定(表示用): `λ=20, A=100, gas=1.33`
- 生成総数: 175枚（`paper/figures/compare_fit_*_shared.svg`）。

### LSB/HSB 微細グリッド（A=112を含む）
- 実行:
  - LSB → `data/results/multi_fit_lsb_fineA112_orth_eps0.8_eg015.json`
  - HSB → `data/results/multi_fit_hsb_fineA112_orth_eps0.8_eg015.json`
- 最良（再確認）:
  - LSB: `λ≈18, A≈125, gas≈1.33`
  - HSB: `λ≈24, A≈125, gas≈1.33`

### alpha_line 分布（LSB vs HSB）
- スクリプト: `scripts/analyze_groups.py`
- 出力:
  - CSV: `assets/results/alpha_line_lsb.csv`, `alpha_line_hsb.csv`
  - 集計: `assets/results/alpha_line_stats.json`
  - 図: `assets/figures/alpha_line_lsb_hsb_hist.png`
- 要約統計(抜粋): `alpha_line_stats.json` 参照（中央値はHSB>LSBの傾向）。

### レポート/SOTA
- `scripts/build_report.py` 実行で群別fineレポートを追加。
- `scripts/build_state_of_the_art.py` 実行でSOTAを再生成（代表図は共有図へ置換優先）。

## 追記: 5-fold 交差検証 (2025-09-01 17:05 UTC)

- スクリプト: `scripts/cross_validate_shared.py`
- 設定: 共有(λ,A)のグリッド `{18,20,22,24}×{100,112,125}`、`gas={1.0,1.33}`。
- 手順: 各foldで train(4/5) に対してグリッド探索→best(λ,A,gas) を選択、test(1/5) をそのbestで評価。
- 出力:
  - JSON: `data/results/cv_shared_summary.json`
  - HTML: `server/public/reports/cv_shared.html`
- 集計（test合算）:
  - 合計χ²: GR ≈ 3.06e4 / ULW ≈ 7.70e3（改善倍率×3.97）
  - ΔAICc ≈ -2.29e4（ULW優位）
- 備考: gas_scaleはfoldごとにtrainから選択（多くで1.33）

## 追記: ブートストラップによる(λ,A)不確かさ (2025-09-01 18:25 UTC)

- スクリプト: `scripts/bootstrap_group_params.py`
- 設定: LSB/HSB 各B=4（試行版）; グリッド `{18,20,22,24}×{100,112,125}`、`gas={1.0,1.33}`
- 出力: `data/results/boot_lsb.json`, `boot_hsb.json`
- 図: `assets/figures/boot_lam_lsb.png`, `boot_lam_hsb.png`
- 所見: 小サンプルながら、LSBで`λ=18`の頻度が高く、HSBで`λ=24`の頻度が高い傾向。Bを増やした本走で確認予定。
- 備考: 本CVではgas_scaleも学習セットから選択し固定。次段でgas_scale自由度のペナルティ評価（情報量基準）を追加予定。
