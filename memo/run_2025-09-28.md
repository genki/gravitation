# 通知系修正（Slack未達の原因特定と解消）

## 結果サマリ
- Slack通知が届かない根因を特定し修正しました。
- `scripts/notice_to_file.sh` の `tac | head` パイプが `set -o pipefail` 下で SIGPIPE により RC=141 を返し、親の `scripts/notice.sh` が早期終了→Slack分岐未到達となっていました。
- パイプを `tail -n 50 | tac` に置換して SIGPIPE を回避。`notify`/`notify-done` からの Slack 送信が復活し、HTTP 200/"ok" を確認しました。

## 生成物
- 修正ファイル:
  - `scripts/notice_to_file.sh`（パイプ構成の変更）
  - `scripts/notice.sh`（Slack可視化の強化: `NOTICE_SLACK_STDOUT=1` で標準出力に成否を出力、`NOTICE_DEBUG_SLACK` で詳細トレース）
  - `Makefile`（`notify`/`notify-done` で `NOTICE_SLACK_SYNC=1 NOTICE_SLACK_VERBOSE=1 NOTICE_SLACK_STDOUT=1` を付与）
- 検証ログ: `server/public/reports/logs/notice_slack_*.log`（HTTP/2 200 + body=ok を記録）

## 研究進捗（FASTキックオフ）
- MACSJ0416 — FAST（outer, rng=42）をBG起動。
  - cmd: `PYTHONPATH=. ./.venv/bin/python scripts/reports/make_bullet_holdout.py --train Abell1689,CL0024 --holdout MACSJ0416 --fast --downsample 2 --float32 --band 8-16 --sigma-psf 1.0,1.5 --sigma-highpass 1.0,1.5 --roi-quantiles 0.70,0.80,0.85 --weight-powers 0.0,0.3 --perm-n 1200 --perm-earlystop --perm-max 2000 --block-pix 6`
  - log: `server/public/reports/logs/holdout_MACSJ0416_FAST_20250928_094248.log`
- AbellS1063 — FAST（outer, rng=42, Σ_e変換=none）をBG起動。
  - cmd: `... make_bullet_holdout.py --holdout AbellS1063 --fast ... --se-transform none`
  - log: `server/public/reports/logs/holdout_AbellS1063_FAST_none_20250928_094306.log`
- AbellS1063 — FAST（outer, rng=42, Σ_e変換=asinh）も追加でBG起動。
  - cmd: `... make_bullet_holdout.py --holdout AbellS1063 --fast ... --se-transform asinh`
  - log: `server/public/reports/logs/holdout_AbellS1063_FAST_asinh_20250928_095003.log`
- 目標: outerで p̂<0.02 を検出次第 FULL（n_perm≥1e4, bands=4–8/8–16, σ_psf=1.0/1.5/2.0）に拡張。

### 追加FAST（改善探索; dispatch経由でSlack通知対象）
- MACSJ0416 FAST — band=4–8, block_pix=6, w∈{0,0.3}
  - job: `macs_fast_48_bp6`
  - log: `server/public/reports/logs/macs_fast_48_bp6_*.log`
- AbellS1063 FAST — band=4–8, block_pix=6, Σ_e=none, w∈{0,0.3}
  - job: `abell_fast_48_none`
  - log: `server/public/reports/logs/abell_fast_48_none_*.log`
- AbellS1063 FAST — 4–8 外側強調（radial_exp=2, outer[q]=0.8–0.98, rr_q=0.9）
  - job: `abell_fast_48_outer_emph`
  - log: `server/public/reports/logs/abell_fast_48_outer_emph_*.log`
- MACSJ0416 FAST — 8–16 外側強調（radial_exp=2, outer[q]=0.8–0.98, rr_q=0.9）
  - job: `macs_fast_816_outer_emph`
  - log: `server/public/reports/logs/macs_fast_816_outer_emph_*.log`

### FULL（先行確証・時短、帯域=4–8のみ）
- AbellS1063 FULL — band=4–8, σ_psf=1.0/1.5/2.0, n_perm=10000（rng=42）
  - job: `abell_full_48_none`
  - log: `server/public/reports/logs/abell_full_48_none_*.log`

### 代表比較（rep6）整合の再構築（FAST）
- パイプライン（WS→Φ·η→rep6ページ生成）をBG投入（workers=1, rng=42）
  - job: `rep6_fast_pipeline`
  - log: `server/public/reports/logs/rep6_fast_pipeline_*.log`
  - 出力: `server/public/reports/ws_vs_phieta_rep6.html`

## 次アクション
- 運用: 通常はそのまま運用可。詳細トレースが必要なときのみ `NOTICE_DEBUG_SLACK=1` を一時付与。
- 監視: 当面 `server/public/reports/logs/notice_slack_*.log` の生成を軽く監視。
- 後続: BGジョブ完了トリガのSlack連携も本修正の影響範囲で到達するはず。未達があれば `scripts/jobs/watch_and_notify.py` 側の出力可視化を追加検討。
 - AbellS1063 の asinh 変換（`--se-transform asinh`）を別ジョブで追加評価（同条件）。
